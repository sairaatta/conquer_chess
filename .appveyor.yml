# Build a Windows x64 Release exe with SFML via vcpkg and upload it as an artifact.
version: '{build}'
image: Visual Studio 2022

environment:
  VCPKG_ROOT: C:\Tools\vcpkg
  VCPKG_DEFAULT_TRIPLET: x64-windows
  APPVEYOR_SAVE_CACHE_ON_ERROR: true

# Speed up repeat builds by caching vcpkg-installed packages.
cache:
  - C:\Tools\vcpkg\installed -> **\CMakeLists.txt

install:
  - cmd: >
      cd %VCPKG_ROOT% &&
      git pull &&
      .\bootstrap-vcpkg.bat
  - cmd: >
      %VCPKG_ROOT%\vcpkg.exe install sfml --triplet x64-windows
  - cmd: cd %APPVEYOR_BUILD_FOLDER%

build_script:
  - cmd: >
      mkdir build && cd build &&
      cmake -A x64 ..
        -DCMAKE_BUILD_TYPE=Release
        -DCMAKE_TOOLCHAIN_FILE=%VCPKG_ROOT%\scripts\buildsystems\vcpkg.cmake
        -DVCPKG_TARGET_TRIPLET=x64-windows &&
      cmake --build . --config Release

after_build:
  - ps: |
      $root = $env:APPVEYOR_BUILD_FOLDER
      $out  = Join-Path $root 'dist'
      New-Item -ItemType Directory -Force -Path $out | Out-Null

      # Grab the first Release exe produced (adjust here if you prefer a specific target)
      $exe = Get-ChildItem -Recurse -Filter *.exe -Path "$root\build" |
             Where-Object { $_.FullName -match '\\Release\\' } |
             Sort-Object Length -Descending |
             Select-Object -First 1

      if (-not $exe) { throw "No exe found in the Release build." }

      Copy-Item $exe.FullName $out

      # Copy typical SFML runtime DLLs and their deps from vcpkg
      $bin = Join-Path $env:VCPKG_ROOT 'installed\x64-windows\bin'
      $patterns = @(
        'sfml-*.dll',
        'openal32.dll',
        'freetype*.dll',
        'ogg*.dll',
        'vorbis*.dll',
        'vorbisfile*.dll',
        'vorbisenc*.dll',
        'zlib*.dll',
        'brotli*.dll'
      )
      foreach ($p in $patterns) { Copy-Item (Join-Path $bin $p) $out -ErrorAction SilentlyContinue }

      # Ship game assets if present
      foreach ($folder in @('resources','images')) {
        $src = Join-Path $root $folder
        if (Test-Path $src) { Copy-Item $src $out -Recurse -Force }
      }

artifacts:
  - path: dist\**
    name: conquer_chess-win64
    type: WebDeployPackage

on_failure:
  - ps: Get-ChildItem -Recurse "$env:APPVEYOR_BUILD_FOLDER\build" -ErrorAction SilentlyContinue | Out-String | Write-Host
